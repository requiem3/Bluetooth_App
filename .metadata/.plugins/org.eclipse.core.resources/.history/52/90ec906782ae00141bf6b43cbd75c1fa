package com.example.bluetooth_app;

import java.util.Set;

import android.app.Activity;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.content.Intent;
import android.content.IntentFilter;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;

public class Bluetooth {
	private BluetoothAdapter mBluetoothAdapter;
	private Activity activity; //Activity to store main window's activity
	private ArrayAdapter<String> pDevices; //Array adapter for storing already paired devices
	private IntentFilter filter; //Filter for catching bluetooth device actions
	private Button sButton; //Scan button
	private ListView lvBox; //listview box
    
	/**
	 * default constructor, basic initializations
	 */
	public Bluetooth(Activity activity) {
		this.activity = activity; //Set class activity to the activity passed to it by the main activity window
		pairedDevices = new ArrayAdapter<String>(activity, R.layout.activity_bluetooth__app);
		mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();
		
		sButton = (Button) activity.findViewById(R.id.scanButton); //sButton = scan button
		sButton.setOnClickListener(new View.OnClickListener() { //Listener to check if button is pressed
			public void onClick(View v) { //If button is pressed start discovering and hide button
				startDiscovering();
				sButton.setVisibility(4); //Make button invisible
			}
		});
		
		lvBox = (ListView) activity.findViewById(R.id.deviceList); // lvBox = deviceList listview
		lvBox.setAdapter(pairedDevices);
		
	}
	
	/**
	 * Check if bluetooth is enabled, if not enable it
	 */
	public void getAdapter() {
		if (!mBluetoothAdapter.isEnabled()) {
		    Intent enableBtIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
		    activity.startActivityForResult(enableBtIntent, 1);
		}
		
	}
	
	/**
	 * Check if device is bluetooth compatible
	 */
	public boolean isCompat() {
		if(mBluetoothAdapter == null) {
			return false; //TODO: better error handling
		} else {
			return true;
		}
	}
	
	/**
	 * Close some shit so we do not eat up resources
	 */
	public void destroy() { 
		if(mBluetoothAdapter != null) {
			mBluetoothAdapter.cancelDiscovery(); //cancel discovering devices
		}
	}
	
	/**
	 * Start discovering devices with bluetooth adapter
	 */
	public void startDiscovering() {
		if(mBluetoothAdapter.isDiscovering()) {
			mBluetoothAdapter.cancelDiscovery();
		}
		
		mBluetoothAdapter.startDiscovery();
	}
	
	public void pairedDevices() {
		Set<BluetoothDevice> pairedDevices = mBluetoothAdapter.getBondedDevices();
		// If there are paired devices
		if (pairedDevices.size() > 0) {
		    // Loop through paired devices
		    for (BluetoothDevice device : pairedDevices) {
		        // Add the name and address to an array adapter to show in a ListView
		        pairedDevices.add(device.getName() + "\n" + device.getAddress());
		    }
		}
	}
	
}
